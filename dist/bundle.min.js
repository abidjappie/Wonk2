"use strict";var __awaiter=this&&this.__awaiter||function(v,h,r,_){function s(t){return t instanceof r?t:new r(function(e){e(t)})}return new(r||(r=Promise))(function(t,e){function o(i){try{l(_.next(i))}catch(u){e(u)}}function c(i){try{l(_.throw(i))}catch(u){e(u)}}function l(i){i.done?t(i.value):s(i.value).then(o,c)}l((_=_.apply(v,h||[])).next())})};System.register("animations",[],function(v,h){"use strict";var r,_,s,t=h&&h.id;function e(c,l,i,u){return Math.abs(c)>Math.abs(l)?l+u/i*(c-l):l+u/i*(l-c)}function o(c,l,i){const u=[c];for(let f=0;f<i-1;f++)u.push([e(l[0],c[0],i,f),e(l[1],c[1],i,f),e(l[2],c[2],i,f),e(l[3],c[3],i,f)]);return u}return{setters:[],execute:function(){r=22,v("walkAnimation",_=[[r,r,0,0],[2*r,2*r,r,0],[2*r,2*r,2.2*r,.6*r],[0,0,2*r,r],[-r,0,r,r/2],[-r,-r,0,0],[-2*r,-2*r,0,-r],[-2*r,-2*r,-.6*r,-2.2*r],[0,0,-r,-2*r],[0,r,-r/2,-r]]),v("emoteAnimation",s=o([0,0,0,0],[0,0,60,-60],5))}}}),System.register("helpers",[],function(v,h){"use strict";var r=h&&h.id;function _(s){s>180&&(s=180),s<0&&(s=0);let t=1450;return s==90?t=1450:s>90?t=1450+(s-90)*(2300-1450)/90:t=1450-(90-s)*(1450-600)/90,Math.round(t)}return v("degree2value",_),{setters:[],execute:function(){}}}),System.register("konashi",[],function(v,h){"use strict";var r,_=h&&h.id;return{setters:[],execute:function(){r=class n{static _createUUID(t){return`229b${t}-03fb-40da-98a7-b0def65c2d4b`}static get _serviceUUID(){return n._createUUID("ff00")}static get defaultFilter(){return{filters:[{namePrefix:"konashi"}],optionalServices:[n._serviceUUID]}}static find(t=n.defaultFilter,e=n.DEV.KONASHI){return __awaiter(this,void 0,void 0,function*(){const o=yield navigator.bluetooth.requestDevice(t);return new n(o,e)})}constructor(t,e=n.DEV.KONASHI){this._dev=e,this._device=t,this._c12c={},this._pioOutputs=0,this.onReceived=()=>{}}get _c12cUUIDs(){return this._dev===n.DEV.COCORO?{pioSetting:n._createUUID("3000"),pioPullUp:n._createUUID("3001"),pioOutput:n._createUUID("3002"),pioInputNotification:n._createUUID("3003"),pwmConfig:n._createUUID("3004"),pwmParameter:n._createUUID("3005"),pwmDuty:n._createUUID("3006"),hardPwmConfig:n._createUUID("3007"),hardPwmDuty:n._createUUID("3008"),hardPwmDutyAll:n._createUUID("3009"),hardPwmDutyTime:n._createUUID("3010"),softwareReset:n._createUUID("3013"),hardwareReset:n._createUUID("3014"),hardwareLowBatteryNotification:n._createUUID("3015")}:{pioSetting:n._createUUID("3000"),pioPullUp:n._createUUID("3001"),pioOutput:n._createUUID("3002"),pioInputNotification:n._createUUID("3003"),pwmConfig:n._createUUID("3004"),pwmParameter:n._createUUID("3005"),pwmDuty:n._createUUID("3006"),analogDrive:n._createUUID("3007"),analogInput:n._createUUID("3008"),analogRead0:n._createUUID("3008"),analogRead1:n._createUUID("3009"),analogRead2:n._createUUID("300a"),i2cConfig:n._createUUID("300b"),i2cStartStop:n._createUUID("300c"),i2cWrite:n._createUUID("300d"),i2cReadParameter:n._createUUID("300e"),i2cRead:n._createUUID("300f"),uartConfig:n._createUUID("3010"),uartBaudRate:n._createUUID("3011"),uartTx:n._createUUID("3012"),uartRxNotification:n._createUUID("3013"),hardwareReset:n._createUUID("3014"),hardwareLowBatteryNotification:n._createUUID("3015")}}connect(){return __awaiter(this,void 0,void 0,function*(){if(this._device.gatt){this._gatt=yield this._device.gatt.connect(),this._service=yield this._gatt.getPrimaryService(n._serviceUUID);for(const t of Object.keys(this._c12cUUIDs)){const e=yield this._service.getCharacteristic(this._c12cUUIDs[t]).catch(o=>{console.log(`No Characteristic for ${t} (${this._c12cUUIDs[t]}) found in Service.`)});e&&(this._c12c[t]=e)}}})}disconnect(){this._gatt&&this._gatt.disconnect()}get isConnected(){var t;return!!(!((t=this._gatt)===null||t===void 0)&&t.connected)}get deviceName(){return this._device.name}pinMode(t,e){return __awaiter(this,void 0,void 0,function*(){let c=(yield this._c12c.pioSetting.readValue()).getUint8(0);e===n.OUTPUT?c|=1<<t:c&=~(1<<t)&255,yield this._c12c.pioSetting.writeValue(new Uint8Array([c]))})}pinModeAll(t){return __awaiter(this,void 0,void 0,function*(){t>=0&&t<=255&&(yield this._c12c.pioSetting.writeValue(new Uint8Array([t])))})}pinPullUp(t,e){return __awaiter(this,void 0,void 0,function*(){let c=(yield this._c12c.pioPullUp.readValue()).getUint8(0);e===n.PULLUP?c|=1<<t:c&=~(1<<t)&255,yield this._c12c.pioPullUp.writeValue(new Uint8Array([c]))})}digitalWrite(t,e){return __awaiter(this,void 0,void 0,function*(){e===n.HIGH?this._pioOutputs|=1<<t:this._pioOutputs&=~(1<<t)&255,yield this._c12c.pioOutput.writeValue(new Uint8Array([this._pioOutputs]))})}digitalWriteAll(t){return __awaiter(this,void 0,void 0,function*(){t>=0&&t<=255&&(yield this._c12c.pioOutput.writeValue(new Uint8Array([t])))})}digitalRead(t){return __awaiter(this,void 0,void 0,function*(){return(yield this._c12c.pioInputNotification.readValue()).getUint8(0)>>t&1})}startDigitalInputNotification(t){return __awaiter(this,void 0,void 0,function*(){this.onReceived=e=>{const o=e.target.value;t(o.getUint8(0))},yield this._c12c.pioInputNotification.startNotifications(),this._c12c.pioInputNotification.addEventListener("characteristicvaluechanged",this.onReceived)})}stopDigitalInputNotification(){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.pioInputNotification.stopNotifications(),this._c12c.pioInputNotification.removeEventListener("characteristicvaluechanged",this.onReceived)})}analogRead(t){return __awaiter(this,void 0,void 0,function*(){let e;switch(t){case n.PINS.AIO0:e=this._c12c.analogRead0;break;case n.PINS.AIO1:e=this._c12c.analogRead1;break;case n.PINS.AIO2:e=this._c12c.analogRead2;break;default:return 0}const o=yield e.readValue();return o.getUint8(0)<<8|o.getUint8(1)})}pwmMode(t,e){return __awaiter(this,void 0,void 0,function*(){if(!this._c12c.pwmConfig)throw"pwmConfig is not defined on"+JSON.stringify(this._c12c);let c=(yield this._c12c.pwmConfig.readValue()).getUint8(0);e===n.PWM_MODES.ENABLE||e===n.PWM_MODES.ENABLE_LED_MODE?c|=1<<t:c&=~(1<<t)&255,e===n.PWM_MODES.ENABLE_LED_MODE?(yield this._c12c.pwmConfig.writeValue(new Uint8Array([c])),yield this.pwmPeriod(t,n.PWM_LED_PERIOD),yield this.pwmDuty(t,0)):yield this._c12c.pwmConfig.writeValue(new Uint8Array([c]))})}pwmPeriod(t,e){return __awaiter(this,void 0,void 0,function*(){const o=new Uint8Array([t,e>>24&255,e>>16&255,e>>8&255,e>>0&255]);yield this._c12c.pwmParameter.writeValue(o)})}pwmDuty(t,e){return __awaiter(this,void 0,void 0,function*(){const o=typeof e=="string"?parseInt(e):e,c=new Uint8Array([t,o>>24&255,o>>16&255,o>>8&255,o>>0&255]);yield this._c12c.pwmDuty.writeValue(c)})}pwmWrite(t,e){return __awaiter(this,void 0,void 0,function*(){const o=Math.min(100,Math.max(0,e)),c=n.PWM_LED_PERIOD*o/100;yield this.pwmDuty(t,c)})}hardPwmModeAll(t){return __awaiter(this,void 0,void 0,function*(){t>=0&&t<=15&&(yield this._c12c.hardPwmConfig.writeValue(new Uint8Array([t])))})}hardPwmDuty(t,e){return __awaiter(this,void 0,void 0,function*(){var o=new Uint8Array([t,e>>8&255,e>>0&255]);yield this._c12c.hardPwmDuty.writeValue(o)})}hardPwmDutyAll(t){return __awaiter(this,void 0,void 0,function*(){const e=new Uint8Array([t[0]>>8&255,t[0]>>0&255,t[1]>>8&255,t[1]>>0&255,t[2]>>8&255,t[2]>>0&255,t[3]>>8&255,t[3]>>0&255]);yield this._c12c.hardPwmDutyAll.writeValue(e)})}hardPwmDutyTime(t,e,o){return __awaiter(this,void 0,void 0,function*(){var c=new Uint8Array([t,e>>8&255,e>>0&255,o>>8&255,o>>0&255]);yield this._c12c.hardPwmDutyTime.writeValue(c)})}uartMode(t){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.uartConfig.writeValue(new Uint8Array([t]))})}uartBaudRate(t){return __awaiter(this,void 0,void 0,function*(){const e=new Uint8Array([t>>8&255,t&255]);yield this._c12c.uartBaudRate.writeValue(e)})}uartWrite(t){return __awaiter(this,void 0,void 0,function*(){const e=n.UART.DATA_MAX_LENGTH;t.length<=e&&(yield this._uartWrite(t));const o=[];for(let c=0;c<t.length;c+=e)o.push(t.slice(c,c+e));yield this._uartWriteChunks(o,0)})}_uartWriteChunks(t,e){return __awaiter(this,void 0,void 0,function*(){t.length<=e||(yield this._uartWrite(t[e]),yield this._uartWriteChunks(t,e+1))})}_uartWrite(t){return __awaiter(this,void 0,void 0,function*(){if(n.UART.DATA_MAX_LENGTH<t.length)throw new Error("The data size has to be less then "+n.UART.DATA_MAX_LENGTH+".");const e=new Uint8Array(t.length+1);e[0]=t.length,t.forEach((o,c)=>{e[c+1]=o}),yield this._c12c.uartTx.writeValue(e)})}i2cMode(t){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.i2cConfig.writeValue(new Uint8Array([t]))})}i2cStopCondition(){return __awaiter(this,void 0,void 0,function*(){yield this._i2cSendCondition(n.I2C.STOP_CONDITION)})}i2cStartCondition(){return __awaiter(this,void 0,void 0,function*(){yield this._i2cSendCondition(n.I2C.START_CONDITION)})}i2cRestartCondition(){return __awaiter(this,void 0,void 0,function*(){yield this._i2cSendCondition(n.I2C.RESTART_CONDITION)})}_i2cSendCondition(t){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.i2cStartStop.writeValue(new Uint8Array([t]))})}i2cWrite(t,e){return __awaiter(this,void 0,void 0,function*(){const o=n.I2C.DATA_MAX_LENGTH;e.length<=o&&(yield this._i2cWrite(t,e));const c=[];for(let l=0;l<e.length;l+=o)c.push(e.slice(l,l+o));yield this._i2cWriteChunks(t,c,0)})}_i2cWriteChunks(t,e,o){return __awaiter(this,void 0,void 0,function*(){e.length<=o||(yield this._i2cWrite(t,e[o]),yield this._i2cWriteChunks(t,e,o+1))})}_i2cWrite(t,e){return __awaiter(this,void 0,void 0,function*(){if(n.I2C.DATA_MAX_LENGTH<e.length)throw new Error("The data size has to be less than "+n.I2C.DATA_MAX_LENGTH+".");const o=new Uint8Array(n.I2C.DATA_MAX_LENGTH+2);o[0]=e.length+1,o[1]=t<<1&254,e.forEach((c,l)=>{o[l+2]=c}),yield this._c12c.i2cWrite.writeValue(o)})}i2cRead(t,e){return __awaiter(this,void 0,void 0,function*(){return yield this._i2cReadRequest(t,e),yield this._i2cRead()})}_i2cReadRequest(t,e){return __awaiter(this,void 0,void 0,function*(){if(n.I2C.DATA_MAX_LENGTH<e)throw new Error("The data size has to be less than "+n.I2C.DATA_MAX_LENGTH+".");const o=new Uint8Array(2);o[0]=e,o[1]=t<<1|1,yield this._c12c.i2cReadParameter.writeValue(o)})}_i2cRead(t=()=>{}){return __awaiter(this,void 0,void 0,function*(){const e=yield this._c12c.i2cRead.readValue();t(e)})}softwareReset(){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.softwareReset.writeValue(new Uint8Array([1]))})}reset(){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.hardwareReset.writeValue(new Uint8Array([1]))})}readBatteryLevel(){return __awaiter(this,void 0,void 0,function*(){return this._gatt?(yield(yield(yield this._gatt.getPrimaryService("battery_service")).getCharacteristic("battery_level")).readValue()).getUint8(0):void 0})}readSignalStrength(){return __awaiter(this,void 0,void 0,function*(){return 0})}_throwError(t){throw console.log(t),t}},v("Konashi",r),v("default",r),function(s){let t;(function(i){i[i.KONASHI=0]="KONASHI",i[i.COCORO=1]="COCORO"})(t=s.DEV||(s.DEV={}));let e;(function(i){i[i.PIO0=0]="PIO0",i[i.PIO1=1]="PIO1",i[i.PIO2=2]="PIO2",i[i.PIO3=3]="PIO3",i[i.PIO4=4]="PIO4",i[i.PIO5=5]="PIO5",i[i.PIO6=6]="PIO6",i[i.PIO7=7]="PIO7",i[i.AIO0=0]="AIO0",i[i.AIO1=1]="AIO1",i[i.AIO2=2]="AIO2",i[i.I2C_SDA=6]="I2C_SDA",i[i.I2C_SCL=7]="I2C_SCL"})(e=s.PINS||(s.PINS={}));let o;(function(i){i[i.DISABLE=0]="DISABLE",i[i.ENABLE=1]="ENABLE",i[i.ENABLE_LED_MODE=2]="ENABLE_LED_MODE"})(o=s.PWM_MODES||(s.PWM_MODES={})),s.HIGH=1,s.LOW=0,s.OUTPUT=1,s.INPUT=0,s.PULLUP=1,s.NO_PULLS=0,s.PWM_LED_PERIOD=1e4,s.ANALOG_REFERENCE=1300;let c;(function(i){i[i.DISABLE=0]="DISABLE",i[i.ENABLE=1]="ENABLE",i[i.ENABLE_100K=1]="ENABLE_100K",i[i.ENABLE_400K=2]="ENABLE_400K",i[i.STOP_CONDITION=1]="STOP_CONDITION",i[i.START_CONDITION=2]="START_CONDITION",i[i.RESTART_CONDITION=3]="RESTART_CONDITION",i[i.DATA_MAX_LENGTH=16]="DATA_MAX_LENGTH"})(c=s.I2C||(s.I2C={}));let l;(function(i){i[i.DISABLE=0]="DISABLE",i[i.ENABLE=1]="ENABLE",i[i.RATE_2K4=10]="RATE_2K4",i[i.RATE_9K6=40]="RATE_9K6",i[i.DATA_MAX_LENGTH=19]="DATA_MAX_LENGTH"})(l=s.UART||(s.UART={}))}(r||(r={})),v("Konashi",r)}}}),System.register("kstate",[],function(v,h){"use strict";var r,_=h&&h.id;return{setters:[],execute:function(){r=class{constructor(t){this.state=t.state,this.actions=t.actions,this.setters=t.setters,this.getters=t.getters,this.commit=this.commit.bind(this),this.dispatch=this.dispatch.bind(this),this.history=[]}commit(t,...e){this.history.push(["Commit",String(t),JSON.stringify(e)]),this.setters[t](this,...e)}dispatch(t,...e){return __awaiter(this,void 0,void 0,function*(){this.history.push(["Dispatch",String(t),JSON.stringify(e)]);const o=yield this.actions[t](this,...e).catch(c=>{throw this.history.push(["Rejected",String(t),"Error"]),c});return this.history.push(["Response",String(t),o?JSON.stringify(o):"Success"]),o})}useGetter(t){return()=>this.getters[t](this)}},v("ControllerState",r),v("default",r)}}}),System.register("main",["konashi","kstate","helpers","animations"],function(v,h){"use strict";var r,_,s,t,e=h&&h.id;function o(i,u=r.default.PWM_MODES.DISABLE,f=0){return{number:i,pwmMode:u,pwmRatio:f}}function c(i){const u={};for(const f of i)u[f]=o(f);return u}function l(i){let u;const f=new _.default({state:{deviceName:"",isSending:!1,pins:c([r.default.PINS.PIO0,r.default.PINS.PIO1,r.default.PINS.PIO2,r.default.PINS.PIO3,r.default.PINS.PIO4,r.default.PINS.PIO5,r.default.PINS.PIO6,r.default.PINS.PIO7])},setters:{SET_PIN_STATE({state:a},d,A){A.pwmMode&&(a.pins[d].pwmMode=A.pwmMode),A.pwmRatio&&(a.pins[d].pwmRatio=A.pwmRatio)},SET_DEVICE_NAME({state:a},d){a.deviceName=d},SET_IS_SENDING({state:a},d){a.isSending=d}},getters:{getPins({state:a}){return Object.keys(a.pins)}},actions:{PIN_MODE_ALL({},a){return __awaiter(this,void 0,void 0,function*(){const d=yield u.pinModeAll(a);return yield D(200),d})},HARD_PWM_MODE_ALL({},a){return __awaiter(this,void 0,void 0,function*(){const d=yield u.hardPwmModeAll(a);return yield D(200),d})},HARD_PWM_DUTY({},a,d){return __awaiter(this,void 0,void 0,function*(){const A=yield u.hardPwmDuty(a,d);return yield D(200),A})},HARD_PWM_DUTY_ALL({},a){return __awaiter(this,void 0,void 0,function*(){const d=yield u.hardPwmDutyAll(a);return yield D(50),yield u.hardPwmDutyAll(a),yield D(150),d})},PWM_MODE({state:a,commit:d},A,I){return __awaiter(this,void 0,void 0,function*(){const m=yield u.pwmMode(A,I);return d("SET_PIN_STATE",A,{pwmMode:I}),yield D(200),m})},PWM_WRITE({state:a,commit:d},A,I){return __awaiter(this,void 0,void 0,function*(){const m=yield u.pwmWrite(A,I).catch(R=>{console.log(R)});return d("SET_PIN_STATE",A,{pwmRatio:I}),yield D(200),m})}}});function D(a=50){return __awaiter(this,void 0,void 0,function*(){return new Promise(d=>setTimeout(d,a))})}function O(){return __awaiter(this,void 0,void 0,function*(){try{if(u&&u.disconnect(),u=yield r.default.find({filters:[{namePrefix:"cocorokit+"}],optionalServices:[r.default._serviceUUID]},r.default.DEV.COCORO),yield u.connect(),!u.isConnected)throw"Could not connect to device.";yield f.dispatch("PIN_MODE_ALL",7),yield f.dispatch("PWM_MODE",r.default.PINS.PIO0,r.default.PWM_MODES.ENABLE),D(500),yield f.dispatch("PWM_MODE",r.default.PINS.PIO1,r.default.PWM_MODES.ENABLE),D(500),yield f.dispatch("PWM_MODE",r.default.PINS.PIO2,r.default.PWM_MODES.ENABLE),yield f.dispatch("HARD_PWM_MODE_ALL",15),f.commit("SET_DEVICE_NAME",u.deviceName),f.commit("SET_IS_SENDING",!1);const a=f.useGetter("getPins");for(const d of a())yield f.dispatch("PWM_MODE",d,r.default.PWM_MODES.ENABLE_LED_MODE),yield f.dispatch("PWM_WRITE",d,0);return i(),Promise.resolve()}catch(a){return u&&u.disconnect(),Promise.reject(a)}})}let E=[6,-9,-4,2],y=!1;function U(a){return __awaiter(this,void 0,void 0,function*(){return yield f.dispatch("HARD_PWM_DUTY_ALL",[s.degree2value(90+a[0]+E[0]),s.degree2value(90+a[1]+E[1]),s.degree2value(90+a[2]+E[2]),s.degree2value(90+a[3]+E[3])])})}function p(){return __awaiter(this,void 0,void 0,function*(){y=!0;for(let a=0;a<=t.walkAnimation.length&&y;a+=1)a==t.walkAnimation.length&&(a=0),yield U(t.walkAnimation[a])})}let w=0;function g(){return __awaiter(this,void 0,void 0,function*(){w==t.walkAnimation.length&&(w=0),yield U(t.walkAnimation[w]),w+=1})}function P(){return __awaiter(this,void 0,void 0,function*(){y=!0;for(let a=0;a<=t.emoteAnimation.length&&y;a+=1)a==t.emoteAnimation.length&&(a=0),yield U(t.emoteAnimation[a])})}function N(a){return __awaiter(this,void 0,void 0,function*(){y=!0;for(let d=0;d<=a.length&&y;d+=1)d==a.length&&(d=0),yield U(a[d])})}function T(){return __awaiter(this,void 0,void 0,function*(){y=!1,w=0,yield U([0,0,0,0])})}function S(){return u&&u.disconnect(),Promise.resolve()}function L(){u&&u.reset()}function M(){u&&u.softwareReset()}return{connect:O,disconnect:S,animate:U,walkAnimation:p,walkStep:g,emoteAnimation:P,customAnimation:N,resetState:T,controllerState:f,softwareReset:M,hardwareReset:L}}return{setters:[function(i){r=i},function(i){_=i},function(i){s=i},function(i){t=i}],execute:function(){window.Controller=l(()=>{})}}});
