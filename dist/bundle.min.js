"use strict";var __awaiter=this&&this.__awaiter||function(h,f,r,_){function d(t){return t instanceof r?t:new r(function(e){e(t)})}return new(r||(r=Promise))(function(t,e){function o(i){try{l(_.next(i))}catch(a){e(a)}}function s(i){try{l(_.throw(i))}catch(a){e(a)}}function l(i){i.done?t(i.value):d(i.value).then(o,s)}l((_=_.apply(h,f||[])).next())})};System.register("animations",[],function(h,f){"use strict";var r,_,d,t=f&&f.id;function e(s,l,i,a){return Math.abs(s)>Math.abs(l)?l+a/i*(s-l):l+a/i*(l-s)}function o(s,l,i){const a=[s];for(let v=0;v<i-1;v++)a.push([e(l[0],s[0],i,v),e(l[1],s[1],i,v),e(l[2],s[2],i,v),e(l[3],s[3],i,v)]);return a}return{setters:[],execute:function(){r=22,h("walkAnimation",_=[[r,r,0,0],[2*r,2*r,r,0],[2*r,2*r,2.2*r,.6*r],[0,0,2*r,r],[-r,0,r,r/2],[-r,-r,0,0],[-2*r,-2*r,0,-r],[-2*r,-2*r,-.6*r,-2.2*r],[0,0,-r,-2*r],[0,r,-r/2,-r]]),h("emoteAnimation",d=o([0,0,0,0],[0,0,60,-60],5))}}}),System.register("helpers",[],function(h,f){"use strict";var r=f&&f.id;function _(t){return t>90&&(t=90),t<-90&&(t=-90),Math.round(1450-850*(t/90))}h("degreeToValueSG90",_);function d(t){return t<-144&&(t=-144),t>144&&(t=144),Math.round(1520-960*(t/144))}return h("degreeToValueRS304",d),{setters:[],execute:function(){}}}),System.register("konashi",[],function(h,f){"use strict";var r,_=f&&f.id;return{setters:[],execute:function(){r=class n{static _createUUID(t){return`229b${t}-03fb-40da-98a7-b0def65c2d4b`}static get _serviceUUID(){return n._createUUID("ff00")}static get defaultFilter(){return{filters:[{namePrefix:"konashi"}],optionalServices:[n._serviceUUID]}}static find(t=n.defaultFilter,e=n.DEV.KONASHI){return __awaiter(this,void 0,void 0,function*(){const o=yield navigator.bluetooth.requestDevice(t);return new n(o,e)})}constructor(t,e=n.DEV.KONASHI){this._dev=e,this._device=t,this._c12c={},this._pioOutputs=0,this.onReceived=()=>{}}get _c12cUUIDs(){return this._dev===n.DEV.COCORO?{pioSetting:n._createUUID("3000"),pioPullUp:n._createUUID("3001"),pioOutput:n._createUUID("3002"),pioInputNotification:n._createUUID("3003"),pwmConfig:n._createUUID("3004"),pwmParameter:n._createUUID("3005"),pwmDuty:n._createUUID("3006"),hardPwmConfig:n._createUUID("3007"),hardPwmDuty:n._createUUID("3008"),hardPwmDutyAll:n._createUUID("3009"),hardPwmDutyTime:n._createUUID("3010"),softwareReset:n._createUUID("3013"),hardwareReset:n._createUUID("3014"),hardwareLowBatteryNotification:n._createUUID("3015")}:{pioSetting:n._createUUID("3000"),pioPullUp:n._createUUID("3001"),pioOutput:n._createUUID("3002"),pioInputNotification:n._createUUID("3003"),pwmConfig:n._createUUID("3004"),pwmParameter:n._createUUID("3005"),pwmDuty:n._createUUID("3006"),analogDrive:n._createUUID("3007"),analogInput:n._createUUID("3008"),analogRead0:n._createUUID("3008"),analogRead1:n._createUUID("3009"),analogRead2:n._createUUID("300a"),i2cConfig:n._createUUID("300b"),i2cStartStop:n._createUUID("300c"),i2cWrite:n._createUUID("300d"),i2cReadParameter:n._createUUID("300e"),i2cRead:n._createUUID("300f"),uartConfig:n._createUUID("3010"),uartBaudRate:n._createUUID("3011"),uartTx:n._createUUID("3012"),uartRxNotification:n._createUUID("3013"),hardwareReset:n._createUUID("3014"),hardwareLowBatteryNotification:n._createUUID("3015")}}connect(){return __awaiter(this,void 0,void 0,function*(){if(this._device.gatt){this._gatt=yield this._device.gatt.connect(),this._service=yield this._gatt.getPrimaryService(n._serviceUUID);for(const t of Object.keys(this._c12cUUIDs)){const e=yield this._service.getCharacteristic(this._c12cUUIDs[t]).catch(o=>{console.log(`No Characteristic for ${t} (${this._c12cUUIDs[t]}) found in Service.`)});e&&(this._c12c[t]=e)}}})}disconnect(){this._gatt&&this._gatt.disconnect()}get isConnected(){var t;return!!(!((t=this._gatt)===null||t===void 0)&&t.connected)}get deviceName(){return this._device.name}pinMode(t,e){return __awaiter(this,void 0,void 0,function*(){let s=(yield this._c12c.pioSetting.readValue()).getUint8(0);e===n.OUTPUT?s|=1<<t:s&=~(1<<t)&255,yield this._c12c.pioSetting.writeValue(new Uint8Array([s]))})}pinModeAll(t){return __awaiter(this,void 0,void 0,function*(){t>=0&&t<=255&&(yield this._c12c.pioSetting.writeValue(new Uint8Array([t])))})}pinPullUp(t,e){return __awaiter(this,void 0,void 0,function*(){let s=(yield this._c12c.pioPullUp.readValue()).getUint8(0);e===n.PULLUP?s|=1<<t:s&=~(1<<t)&255,yield this._c12c.pioPullUp.writeValue(new Uint8Array([s]))})}digitalWrite(t,e){return __awaiter(this,void 0,void 0,function*(){e===n.HIGH?this._pioOutputs|=1<<t:this._pioOutputs&=~(1<<t)&255,yield this._c12c.pioOutput.writeValue(new Uint8Array([this._pioOutputs]))})}digitalWriteAll(t){return __awaiter(this,void 0,void 0,function*(){t>=0&&t<=255&&(yield this._c12c.pioOutput.writeValue(new Uint8Array([t])))})}digitalRead(t){return __awaiter(this,void 0,void 0,function*(){return(yield this._c12c.pioInputNotification.readValue()).getUint8(0)>>t&1})}startDigitalInputNotification(t){return __awaiter(this,void 0,void 0,function*(){this.onReceived=e=>{const o=e.target.value;t(o.getUint8(0))},yield this._c12c.pioInputNotification.startNotifications(),this._c12c.pioInputNotification.addEventListener("characteristicvaluechanged",this.onReceived)})}stopDigitalInputNotification(){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.pioInputNotification.stopNotifications(),this._c12c.pioInputNotification.removeEventListener("characteristicvaluechanged",this.onReceived)})}analogRead(t){return __awaiter(this,void 0,void 0,function*(){let e;switch(t){case n.PINS.AIO0:e=this._c12c.analogRead0;break;case n.PINS.AIO1:e=this._c12c.analogRead1;break;case n.PINS.AIO2:e=this._c12c.analogRead2;break;default:return 0}const o=yield e.readValue();return o.getUint8(0)<<8|o.getUint8(1)})}pwmMode(t,e){return __awaiter(this,void 0,void 0,function*(){if(!this._c12c.pwmConfig)throw"pwmConfig is not defined on"+JSON.stringify(this._c12c);let s=(yield this._c12c.pwmConfig.readValue()).getUint8(0);e===n.PWM_MODES.ENABLE||e===n.PWM_MODES.ENABLE_LED_MODE?s|=1<<t:s&=~(1<<t)&255,e===n.PWM_MODES.ENABLE_LED_MODE?(yield this._c12c.pwmConfig.writeValue(new Uint8Array([s])),yield this.pwmPeriod(t,n.PWM_LED_PERIOD),yield this.pwmDuty(t,0)):yield this._c12c.pwmConfig.writeValue(new Uint8Array([s]))})}pwmPeriod(t,e){return __awaiter(this,void 0,void 0,function*(){const o=new Uint8Array([t,e>>24&255,e>>16&255,e>>8&255,e>>0&255]);yield this._c12c.pwmParameter.writeValue(o)})}pwmDuty(t,e){return __awaiter(this,void 0,void 0,function*(){const o=typeof e=="string"?parseInt(e):e,s=new Uint8Array([t,o>>24&255,o>>16&255,o>>8&255,o>>0&255]);yield this._c12c.pwmDuty.writeValue(s)})}pwmWrite(t,e){return __awaiter(this,void 0,void 0,function*(){const o=Math.min(100,Math.max(0,e)),s=n.PWM_LED_PERIOD*o/100;yield this.pwmDuty(t,s)})}hardPwmModeAll(t){return __awaiter(this,void 0,void 0,function*(){t>=0&&t<=15&&(yield this._c12c.hardPwmConfig.writeValue(new Uint8Array([t])))})}hardPwmDuty(t,e){return __awaiter(this,void 0,void 0,function*(){var o=new Uint8Array([t,e>>8&255,e>>0&255]);yield this._c12c.hardPwmDuty.writeValue(o)})}hardPwmDutyAll(t){return __awaiter(this,void 0,void 0,function*(){const e=new Uint8Array([t[0]>>8&255,t[0]>>0&255,t[1]>>8&255,t[1]>>0&255,t[2]>>8&255,t[2]>>0&255,t[3]>>8&255,t[3]>>0&255]);yield this._c12c.hardPwmDutyAll.writeValue(e)})}hardPwmDutyTime(t,e,o){return __awaiter(this,void 0,void 0,function*(){var s=new Uint8Array([t,e>>8&255,e>>0&255,o>>8&255,o>>0&255]);yield this._c12c.hardPwmDutyTime.writeValue(s)})}uartMode(t){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.uartConfig.writeValue(new Uint8Array([t]))})}uartBaudRate(t){return __awaiter(this,void 0,void 0,function*(){const e=new Uint8Array([t>>8&255,t&255]);yield this._c12c.uartBaudRate.writeValue(e)})}uartWrite(t){return __awaiter(this,void 0,void 0,function*(){const e=n.UART.DATA_MAX_LENGTH;t.length<=e&&(yield this._uartWrite(t));const o=[];for(let s=0;s<t.length;s+=e)o.push(t.slice(s,s+e));yield this._uartWriteChunks(o,0)})}_uartWriteChunks(t,e){return __awaiter(this,void 0,void 0,function*(){t.length<=e||(yield this._uartWrite(t[e]),yield this._uartWriteChunks(t,e+1))})}_uartWrite(t){return __awaiter(this,void 0,void 0,function*(){if(n.UART.DATA_MAX_LENGTH<t.length)throw new Error("The data size has to be less then "+n.UART.DATA_MAX_LENGTH+".");const e=new Uint8Array(t.length+1);e[0]=t.length,t.forEach((o,s)=>{e[s+1]=o}),yield this._c12c.uartTx.writeValue(e)})}i2cMode(t){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.i2cConfig.writeValue(new Uint8Array([t]))})}i2cStopCondition(){return __awaiter(this,void 0,void 0,function*(){yield this._i2cSendCondition(n.I2C.STOP_CONDITION)})}i2cStartCondition(){return __awaiter(this,void 0,void 0,function*(){yield this._i2cSendCondition(n.I2C.START_CONDITION)})}i2cRestartCondition(){return __awaiter(this,void 0,void 0,function*(){yield this._i2cSendCondition(n.I2C.RESTART_CONDITION)})}_i2cSendCondition(t){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.i2cStartStop.writeValue(new Uint8Array([t]))})}i2cWrite(t,e){return __awaiter(this,void 0,void 0,function*(){const o=n.I2C.DATA_MAX_LENGTH;e.length<=o&&(yield this._i2cWrite(t,e));const s=[];for(let l=0;l<e.length;l+=o)s.push(e.slice(l,l+o));yield this._i2cWriteChunks(t,s,0)})}_i2cWriteChunks(t,e,o){return __awaiter(this,void 0,void 0,function*(){e.length<=o||(yield this._i2cWrite(t,e[o]),yield this._i2cWriteChunks(t,e,o+1))})}_i2cWrite(t,e){return __awaiter(this,void 0,void 0,function*(){if(n.I2C.DATA_MAX_LENGTH<e.length)throw new Error("The data size has to be less than "+n.I2C.DATA_MAX_LENGTH+".");const o=new Uint8Array(n.I2C.DATA_MAX_LENGTH+2);o[0]=e.length+1,o[1]=t<<1&254,e.forEach((s,l)=>{o[l+2]=s}),yield this._c12c.i2cWrite.writeValue(o)})}i2cRead(t,e){return __awaiter(this,void 0,void 0,function*(){return yield this._i2cReadRequest(t,e),yield this._i2cRead()})}_i2cReadRequest(t,e){return __awaiter(this,void 0,void 0,function*(){if(n.I2C.DATA_MAX_LENGTH<e)throw new Error("The data size has to be less than "+n.I2C.DATA_MAX_LENGTH+".");const o=new Uint8Array(2);o[0]=e,o[1]=t<<1|1,yield this._c12c.i2cReadParameter.writeValue(o)})}_i2cRead(t=()=>{}){return __awaiter(this,void 0,void 0,function*(){const e=yield this._c12c.i2cRead.readValue();t(e)})}softwareReset(){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.softwareReset.writeValue(new Uint8Array([1]))})}reset(){return __awaiter(this,void 0,void 0,function*(){yield this._c12c.hardwareReset.writeValue(new Uint8Array([1]))})}readBatteryLevel(){return __awaiter(this,void 0,void 0,function*(){return this._gatt?(yield(yield(yield this._gatt.getPrimaryService("battery_service")).getCharacteristic("battery_level")).readValue()).getUint8(0):void 0})}readSignalStrength(){return __awaiter(this,void 0,void 0,function*(){return 0})}_throwError(t){throw console.log(t),t}},h("Konashi",r),h("default",r),function(d){let t;(function(i){i[i.KONASHI=0]="KONASHI",i[i.COCORO=1]="COCORO"})(t=d.DEV||(d.DEV={}));let e;(function(i){i[i.PIO0=0]="PIO0",i[i.PIO1=1]="PIO1",i[i.PIO2=2]="PIO2",i[i.PIO3=3]="PIO3",i[i.PIO4=4]="PIO4",i[i.PIO5=5]="PIO5",i[i.PIO6=6]="PIO6",i[i.PIO7=7]="PIO7",i[i.AIO0=0]="AIO0",i[i.AIO1=1]="AIO1",i[i.AIO2=2]="AIO2",i[i.I2C_SDA=6]="I2C_SDA",i[i.I2C_SCL=7]="I2C_SCL"})(e=d.PINS||(d.PINS={}));let o;(function(i){i[i.DISABLE=0]="DISABLE",i[i.ENABLE=1]="ENABLE",i[i.ENABLE_LED_MODE=2]="ENABLE_LED_MODE"})(o=d.PWM_MODES||(d.PWM_MODES={})),d.HIGH=1,d.LOW=0,d.OUTPUT=1,d.INPUT=0,d.PULLUP=1,d.NO_PULLS=0,d.PWM_LED_PERIOD=1e4,d.ANALOG_REFERENCE=1300;let s;(function(i){i[i.DISABLE=0]="DISABLE",i[i.ENABLE=1]="ENABLE",i[i.ENABLE_100K=1]="ENABLE_100K",i[i.ENABLE_400K=2]="ENABLE_400K",i[i.STOP_CONDITION=1]="STOP_CONDITION",i[i.START_CONDITION=2]="START_CONDITION",i[i.RESTART_CONDITION=3]="RESTART_CONDITION",i[i.DATA_MAX_LENGTH=16]="DATA_MAX_LENGTH"})(s=d.I2C||(d.I2C={}));let l;(function(i){i[i.DISABLE=0]="DISABLE",i[i.ENABLE=1]="ENABLE",i[i.RATE_2K4=10]="RATE_2K4",i[i.RATE_9K6=40]="RATE_9K6",i[i.DATA_MAX_LENGTH=19]="DATA_MAX_LENGTH"})(l=d.UART||(d.UART={}))}(r||(r={})),h("Konashi",r)}}}),System.register("kstate",[],function(h,f){"use strict";var r,_=f&&f.id;return{setters:[],execute:function(){r=class{constructor(t){this.state=t.state,this.actions=t.actions,this.setters=t.setters,this.getters=t.getters,this.commit=this.commit.bind(this),this.dispatch=this.dispatch.bind(this),this.history=[]}commit(t,...e){this.history.push(["Commit",String(t),JSON.stringify(e)]),this.setters[t](this,...e)}dispatch(t,...e){return __awaiter(this,void 0,void 0,function*(){this.history.push(["Dispatch",String(t),JSON.stringify(e)]);const o=yield this.actions[t](this,...e).catch(s=>{throw this.history.push(["Rejected",String(t),"Error"]),s});return this.history.push(["Response",String(t),o?JSON.stringify(o):"Success"]),o})}useGetter(t){return()=>this.getters[t](this)}},h("ControllerState",r),h("default",r)}}}),System.register("main",["konashi","kstate","helpers","animations"],function(h,f){"use strict";var r,_,d,t,e=f&&f.id;function o(i,a=r.default.PWM_MODES.DISABLE,v=0){return{number:i,pwmMode:a,pwmRatio:v}}function s(i){const a={};for(const v of i)a[v]=o(v);return a}function l(i){let a,v="sg90";const A=new _.default({state:{deviceName:"",isSending:!1,pins:s([r.default.PINS.PIO0,r.default.PINS.PIO1,r.default.PINS.PIO2,r.default.PINS.PIO3,r.default.PINS.PIO4,r.default.PINS.PIO5,r.default.PINS.PIO6,r.default.PINS.PIO7])},setters:{SET_PIN_STATE({state:c},u,D){D.pwmMode&&(c.pins[u].pwmMode=D.pwmMode),D.pwmRatio&&(c.pins[u].pwmRatio=D.pwmRatio)},SET_DEVICE_NAME({state:c},u){c.deviceName=u},SET_IS_SENDING({state:c},u){c.isSending=u}},getters:{getPins({state:c}){return Object.keys(c.pins)}},actions:{PIN_MODE_ALL({},c){return __awaiter(this,void 0,void 0,function*(){const u=yield a.pinModeAll(c);return yield y(200),u})},HARD_PWM_MODE_ALL({},c){return __awaiter(this,void 0,void 0,function*(){const u=yield a.hardPwmModeAll(c);return yield y(200),u})},HARD_PWM_DUTY({},c,u){return __awaiter(this,void 0,void 0,function*(){const D=yield a.hardPwmDuty(c,u);return yield y(200),D})},HARD_PWM_DUTY_ALL({},c){return __awaiter(this,void 0,void 0,function*(){const u=yield a.hardPwmDutyAll(c);return yield y(50),yield a.hardPwmDutyAll(c),yield y(150),u})},PWM_MODE({state:c,commit:u},D,E){return __awaiter(this,void 0,void 0,function*(){const O=yield a.pwmMode(D,E);return u("SET_PIN_STATE",D,{pwmMode:E}),yield y(200),O})},PWM_WRITE({state:c,commit:u},D,E){return __awaiter(this,void 0,void 0,function*(){const O=yield a.pwmWrite(D,E).catch(x=>{console.log(x)});return u("SET_PIN_STATE",D,{pwmRatio:E}),yield y(200),O})}}});function y(c=50){return __awaiter(this,void 0,void 0,function*(){return new Promise(u=>setTimeout(u,c))})}function p(){return __awaiter(this,void 0,void 0,function*(){try{if(a&&a.disconnect(),a=yield r.default.find({filters:[{namePrefix:"cocorokit+"}],optionalServices:[r.default._serviceUUID]},r.default.DEV.COCORO),yield a.connect(),!a.isConnected)throw"Could not connect to device.";yield A.dispatch("PIN_MODE_ALL",7),yield A.dispatch("PWM_MODE",r.default.PINS.PIO0,r.default.PWM_MODES.ENABLE),y(500),yield A.dispatch("PWM_MODE",r.default.PINS.PIO1,r.default.PWM_MODES.ENABLE),y(500),yield A.dispatch("PWM_MODE",r.default.PINS.PIO2,r.default.PWM_MODES.ENABLE),yield A.dispatch("HARD_PWM_MODE_ALL",15),A.commit("SET_DEVICE_NAME",a.deviceName),A.commit("SET_IS_SENDING",!1);const c=A.useGetter("getPins");for(const u of c())yield A.dispatch("PWM_MODE",u,r.default.PWM_MODES.ENABLE_LED_MODE),yield A.dispatch("PWM_WRITE",u,0);return i(),Promise.resolve()}catch(c){return a&&a.disconnect(),Promise.reject(c)}})}let m=[0,0,0,0],U=!1;function w(c){return __awaiter(this,void 0,void 0,function*(){const u=v==="rs304"?d.degreeToValueRS304:d.degreeToValueSG90;return yield A.dispatch("HARD_PWM_DUTY_ALL",[u(c[0]+m[0]),u(c[1]+m[1]),u(c[2]+m[2]),u(c[3]+m[3])])})}function g(){return __awaiter(this,void 0,void 0,function*(){U=!0;for(let c=0;c<=t.walkAnimation.length&&U;c+=1)c==t.walkAnimation.length&&(c=0),yield w(t.walkAnimation[c])})}let I=0;function P(){return __awaiter(this,void 0,void 0,function*(){I==t.walkAnimation.length&&(I=0),yield w(t.walkAnimation[I]),I+=1})}function N(){return __awaiter(this,void 0,void 0,function*(){U=!0;for(let c=0;c<=t.emoteAnimation.length&&U;c+=1)c==t.emoteAnimation.length&&(c=0),yield w(t.emoteAnimation[c])})}function T(c){return __awaiter(this,void 0,void 0,function*(){U=!0;for(let u=0;u<=c.length&&U;u+=1)u==c.length&&(u=0),yield w(c[u])})}function S(c=!0){return __awaiter(this,void 0,void 0,function*(){U=!1,I=0,c&&(yield w([0,0,0,0]))})}function M(){return a&&a.disconnect(),Promise.resolve()}function L(){a&&a.reset()}function R(){a&&a.softwareReset()}function C(c){v=c}return{connect:p,disconnect:M,animate:w,walkAnimation:g,walkStep:P,emoteAnimation:N,customAnimation:T,resetState:S,controllerState:A,softwareReset:R,hardwareReset:L,setDriver:C}}return{setters:[function(i){r=i},function(i){_=i},function(i){d=i},function(i){t=i}],execute:function(){window.Controller=l(()=>{})}}});
